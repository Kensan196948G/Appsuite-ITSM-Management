# システムアーキテクチャ設計書（System Architecture Design）

**ドキュメントID:** WUI-ARCH-001
**プロジェクト名:** WebUI サンプルシステム
**バージョン:** 1.0.0
**作成日:** 2026-02-25
**最終更新日:** 2026-02-25
**ステータス:** Draft

---

## 1. アーキテクチャ概要

### 1.1 アーキテクチャパターン

本システムは **SPA（Single Page Application）+ REST API** アーキテクチャを採用する。

```
┌─────────────────────────────────────────────────────────┐
│                     クライアント層                        │
│  ┌─────────────────────────────────────────────────┐   │
│  │     React SPA (TypeScript + Vite)               │   │
│  │  ┌──────────┐ ┌──────────┐ ┌─────────────────┐ │   │
│  │  │  Pages   │ │Components│ │  State(Zustand) │ │   │
│  │  └──────────┘ └──────────┘ └─────────────────┘ │   │
│  │  ┌──────────────────────┐ ┌─────────────────┐  │   │
│  │  │  API Client(React   │ │  Router         │  │   │
│  │  │  Query + Axios)     │ │  (React Router) │  │   │
│  │  └──────────────────────┘ └─────────────────┘  │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────┬───────────────────────────────┘
                           │ HTTPS / REST API
┌─────────────────────────▼───────────────────────────────┐
│                      CDN / エッジ層                        │
│         CloudFront / Cloudflare                          │
│  ・静的アセット配信  ・キャッシュ  ・WAF  ・DDoS保護       │
└─────────────────────────┬───────────────────────────────┘
                           │
┌─────────────────────────▼───────────────────────────────┐
│                    APIサーバー層                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │  REST API Server (Node.js / Express)            │   │
│  │  ・認証・認可  ・ビジネスロジック  ・バリデーション  │   │
│  └─────────────────────────────────────────────────┘   │
└──────┬──────────────────────┬────────────────────────────┘
       │                      │
┌──────▼──────┐    ┌──────────▼──────────┐
│ データベース  │    │  外部サービス          │
│  PostgreSQL  │    │  ・OAuth (Google)    │
│  Redis Cache │    │  ・SMTP (メール)     │
└─────────────┘    │  ・S3 (ファイル)     │
                    └──────────────────────┘
```

---

## 2. フロントエンドアーキテクチャ

### 2.1 技術スタック

| カテゴリ | 採用技術 | バージョン | 選定理由 |
|---------|---------|----------|---------|
| UIフレームワーク | React | 18.x | 豊富なエコシステム・コミュニティ |
| 言語 | TypeScript | 5.x | 型安全・IDEサポート |
| ビルドツール | Vite | 5.x | 高速な開発サーバー・ビルド |
| ルーティング | React Router | 6.x | SPA標準ルーター |
| 状態管理 | Zustand | 4.x | 軽量・シンプル |
| サーバー状態 | TanStack Query | 5.x | キャッシュ管理・自動再取得 |
| HTTPクライアント | Axios | 1.x | インターセプタ・エラーハンドリング |
| UIコンポーネント | shadcn/ui | latest | アクセシブル・カスタマイズ可能 |
| スタイリング | Tailwind CSS | 3.x | ユーティリティファースト |
| フォーム | React Hook Form | 7.x | パフォーマンス・バリデーション |
| バリデーション | Zod | 3.x | 型安全なスキーマバリデーション |
| テスト | Vitest + Testing Library | latest | Vite統合・直感的API |
| E2Eテスト | Playwright | latest | クロスブラウザ対応 |

### 2.2 ディレクトリ構成

```
src/
├── assets/              # 静的アセット（画像・フォント等）
├── components/
│   ├── ui/              # 基本UIコンポーネント（shadcn/ui）
│   ├── common/          # 共通コンポーネント
│   ├── layout/          # レイアウトコンポーネント
│   └── features/        # 機能コンポーネント
│       ├── auth/
│       ├── dashboard/
│       ├── data/
│       ├── notifications/
│       └── settings/
├── hooks/               # カスタムフック
├── lib/
│   ├── api/             # APIクライアント設定
│   ├── utils/           # ユーティリティ関数
│   └── validations/     # Zodスキーマ定義
├── pages/               # ページコンポーネント
│   ├── auth/
│   ├── dashboard/
│   ├── data/
│   ├── settings/
│   └── errors/
├── router/              # ルーティング設定
├── stores/              # Zustandストア
├── types/               # TypeScript型定義
├── i18n/                # 国際化リソース
│   ├── locales/
│   │   ├── ja.json
│   │   └── en.json
│   └── config.ts
├── styles/              # グローバルスタイル
├── App.tsx
└── main.tsx
```

### 2.3 データフロー

```
[ユーザー操作]
      │
      ▼
[コンポーネント（UI）]
      │
      ├──[ローカル状態]──→ useState / useReducer
      │
      ├──[グローバル状態]──→ Zustand Store
      │
      └──[サーバー状態]──→ TanStack Query
                               │
                               ▼
                         [Axios クライアント]
                               │
                       [リクエストインターセプタ]
                       ・認証トークン付加
                       ・リクエストログ
                               │
                               ▼
                         [REST API サーバー]
                               │
                       [レスポンスインターセプタ]
                       ・401: トークンリフレッシュ
                       ・エラーハンドリング
                               │
                               ▼
                         [TanStack Query キャッシュ]
                               │
                               ▼
                         [コンポーネント再レンダリング]
```

---

## 3. APIサーバーアーキテクチャ

### 3.1 技術スタック

| カテゴリ | 採用技術 | バージョン |
|---------|---------|----------|
| ランタイム | Node.js | 20.x LTS |
| フレームワーク | Express | 4.x |
| 言語 | TypeScript | 5.x |
| ORM | Prisma | 5.x |
| バリデーション | Zod | 3.x |
| 認証 | jsonwebtoken | 9.x |
| ロギング | Pino | 8.x |
| テスト | Jest | 29.x |

### 3.2 レイヤーアーキテクチャ

```
HTTP リクエスト
      │
      ▼
[Router Layer]          ← URLルーティング
      │
      ▼
[Middleware Layer]       ← 認証・レート制限・バリデーション
      │
      ▼
[Controller Layer]      ← リクエスト/レスポンス処理
      │
      ▼
[Service Layer]         ← ビジネスロジック
      │
      ▼
[Repository Layer]      ← データアクセス（Prisma）
      │
      ▼
[Database Layer]        ← PostgreSQL
```

---

## 4. インフラストラクチャ

### 4.1 本番環境構成

```
インターネット
      │
      ▼
[Cloudflare]            ← DNS・CDN・WAF・DDoS保護
      │
      ▼
[AWS Application Load Balancer]
      │
      ├──→ [ECS Fargate: フロントエンド（Nginx）]
      │         ├── 静的ファイル配信
      │         └── SPA ルーティング（history API fallback）
      │
      └──→ [ECS Fargate: APIサーバー]
               ├── コンテナ: node:20-alpine
               └── Auto Scaling（CPU 70%でスケールアウト）
                         │
                    ┌────┴────────────────┐
                    │                     │
              [RDS PostgreSQL]     [ElastiCache Redis]
              Multi-AZ             クラスター
              自動バックアップ      セッション・キャッシュ
```

### 4.2 開発環境構成

```
開発者端末
├── Node.js 20.x
├── Docker Desktop
│   ├── PostgreSQL コンテナ
│   └── Redis コンテナ
└── VS Code + 推奨拡張機能
```

### 4.3 環境変数定義

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `VITE_API_BASE_URL` | APIベースURL | ○ |
| `VITE_APP_ENV` | 環境名（development/staging/production） | ○ |
| `VITE_GOOGLE_CLIENT_ID` | Google OAuth クライアントID | △ |
| `DATABASE_URL` | PostgreSQL接続URL | ○ |
| `REDIS_URL` | Redis接続URL | ○ |
| `JWT_SECRET` | JWT署名シークレット | ○ |
| `JWT_REFRESH_SECRET` | リフレッシュトークン署名シークレット | ○ |
| `SMTP_HOST` | SMTPサーバーホスト | ○ |
| `AWS_S3_BUCKET` | ファイルストレージバケット名 | △ |

---

## 5. セキュリティアーキテクチャ

### 5.1 多層防御

```
[インターネット]
      │
[Cloudflare WAF]        ← SQLi・XSS・DDoS フィルタリング
      │
[HTTPS/TLS 1.3]         ← 通信暗号化
      │
[レート制限]             ← ブルートフォース対策
      │
[JWT認証]               ← トークンベース認証
      │
[RBAC認可]              ← ロールベースアクセス制御
      │
[入力バリデーション]      ← インジェクション対策
      │
[データベース暗号化]      ← 機密データの暗号化保存
```

---

## 6. 監視・可観測性

### 6.1 監視ツール

| カテゴリ | ツール | 用途 |
|---------|-------|------|
| APM | Datadog / New Relic | パフォーマンス・エラー追跡 |
| ログ管理 | CloudWatch Logs / Elasticsearch | 集中ログ管理 |
| アラート | PagerDuty | 障害通知 |
| フロントエンド監視 | Sentry | JSエラー追跡 |
| アップタイム監視 | Uptime Robot | 外形監視 |

### 6.2 主要メトリクス

| メトリクス | 警告閾値 | 緊急閾値 |
|---------|---------|---------|
| APIレスポンス時間（P95） | > 500ms | > 2000ms |
| エラー率 | > 1% | > 5% |
| CPU使用率 | > 70% | > 90% |
| メモリ使用率 | > 80% | > 95% |
| データベース接続数 | > 80% | > 95% |

---

## 7. 改訂履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|---------|--------|
| 1.0.0 | 2026-02-25 | 初版作成 | システム管理者 |
