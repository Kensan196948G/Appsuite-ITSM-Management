# ============================================
# AppSuite ITSM Management System
# Apache VirtualHost Configuration
# ============================================
#
# このファイルをApacheのsites-availableディレクトリにコピーしてください：
# sudo cp config/apache/appsuite-itsm.conf /etc/apache2/sites-available/
# sudo a2ensite appsuite-itsm.conf
# sudo systemctl reload apache2
#
# 必要なApacheモジュール：
# sudo a2enmod ssl headers rewrite deflate expires
# ============================================

# ============================================
# HTTP → HTTPS リダイレクト（ポート80）
# ============================================
<VirtualHost *:80>
    # サーバー名（実際のドメインに変更してください）
    ServerName appsuite-itsm.example.com
    ServerAlias www.appsuite-itsm.example.com

    # 管理者メールアドレス
    ServerAdmin admin@example.com

    # すべてのHTTPリクエストをHTTPSにリダイレクト
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]

    # ログファイル
    ErrorLog ${APACHE_LOG_DIR}/appsuite-itsm-http-error.log
    CustomLog ${APACHE_LOG_DIR}/appsuite-itsm-http-access.log combined
</VirtualHost>

# ============================================
# HTTPS設定（ポート443）
# ============================================
<VirtualHost *:443>
    # サーバー名（実際のドメインに変更してください）
    ServerName appsuite-itsm.example.com
    ServerAlias www.appsuite-itsm.example.com

    # 管理者メールアドレス
    ServerAdmin admin@example.com

    # ドキュメントルート（実際のパスに変更してください）
    DocumentRoot /var/www/appsuite-itsm

    # ============================================
    # SSL/TLS設定
    # ============================================

    # SSL有効化
    SSLEngine on

    # TLS 1.2以上のみ許可（TLS 1.0/1.1は脆弱性のため無効化）
    SSLProtocol -all +TLSv1.2 +TLSv1.3

    # 強固な暗号化スイート（推奨設定）
    SSLCipherSuite HIGH:!aNULL:!MD5:!RC4:!3DES:!DES:!EXP
    SSLHonorCipherOrder on

    # SSL証明書のパス（実際のパスに変更してください）
    # Let's Encryptの場合:
    SSLCertificateFile /etc/letsencrypt/live/appsuite-itsm.example.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/appsuite-itsm.example.com/privkey.pem

    # 自己署名証明書の場合（開発環境のみ）:
    # SSLCertificateFile /etc/ssl/certs/appsuite-itsm.crt
    # SSLCertificateKeyFile /etc/ssl/private/appsuite-itsm.key

    # 中間証明書（必要に応じて）
    # SSLCertificateChainFile /etc/letsencrypt/live/appsuite-itsm.example.com/chain.pem

    # SSL セッションキャッシュ
    SSLSessionCache "shmcb:/var/run/apache2/ssl_scache(512000)"
    SSLSessionCacheTimeout 300

    # ============================================
    # セキュリティヘッダー（7種類）
    # ============================================

    <IfModule mod_headers.c>
        # 1. HSTS (HTTP Strict Transport Security)
        #    - 1年間HTTPSのみでアクセスさせる
        #    - サブドメインにも適用
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

        # 2. Content Security Policy (CSP)
        #    - XSS攻撃・インジェクション攻撃を防止
        #    - 許可するリソース元を制限
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data:; font-src 'self' https://cdnjs.cloudflare.com; connect-src 'self'; frame-ancestors 'self'; base-uri 'self'; form-action 'self'"

        # 3. X-Content-Type-Options
        #    - MIMEタイプスニッフィングを防止
        Header always set X-Content-Type-Options "nosniff"

        # 4. X-Frame-Options
        #    - クリックジャッキング攻撃を防止
        #    - 同一オリジンのみフレーム表示を許可
        Header always set X-Frame-Options "SAMEORIGIN"

        # 5. Referrer-Policy
        #    - リファラー情報の漏洩を制限
        Header always set Referrer-Policy "strict-origin-when-cross-origin"

        # 6. Permissions-Policy
        #    - 不要なブラウザAPIへのアクセスを制限
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), accelerometer=(), gyroscope=()"

        # 7. X-XSS-Protection
        #    - XSS攻撃を防止（旧ブラウザ対応）
        Header always set X-XSS-Protection "1; mode=block"

        # Serverヘッダーの削除（バージョン情報の非表示）
        Header always unset Server
        Header always unset X-Powered-By
    </IfModule>

    # ============================================
    # ディレクトリ設定
    # ============================================

    <Directory /var/www/appsuite-itsm>
        # ディレクトリインデックス無効化（セキュリティ対策）
        Options -Indexes +FollowSymLinks -MultiViews

        # .htaccess使用許可
        AllowOverride All

        # アクセス許可
        Require all granted

        # デフォルトファイル
        DirectoryIndex index.html

        # ============================================
        # SPA (Single Page Application) 対応
        # ============================================
        # すべてのリクエストをindex.htmlにリダイレクト
        RewriteEngine On
        RewriteBase /
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # ============================================
    # 静的リソースへのアクセス許可
    # ============================================

    <Directory /var/www/appsuite-itsm/css>
        Options -Indexes
        Require all granted
    </Directory>

    <Directory /var/www/appsuite-itsm/js>
        Options -Indexes
        Require all granted
    </Directory>

    # ============================================
    # Gzip圧縮（パフォーマンス向上）
    # ============================================

    <IfModule mod_deflate.c>
        # テキストベースのファイルを圧縮
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE text/javascript application/javascript application/x-javascript
        AddOutputFilterByType DEFLATE application/json application/xml
        AddOutputFilterByType DEFLATE image/svg+xml

        # 古いブラウザ対応
        BrowserMatch ^Mozilla/4 gzip-only-text/html
        BrowserMatch ^Mozilla/4\.0[678] no-gzip
        BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    </IfModule>

    # ============================================
    # ブラウザキャッシュ設定
    # ============================================

    <IfModule mod_expires.c>
        ExpiresActive On

        # HTMLファイル：1時間
        ExpiresByType text/html "access plus 1 hour"

        # CSS/JSファイル：7日間
        ExpiresByType text/css "access plus 7 days"
        ExpiresByType application/javascript "access plus 7 days"
        ExpiresByType text/javascript "access plus 7 days"

        # 画像ファイル：30日間
        ExpiresByType image/jpeg "access plus 30 days"
        ExpiresByType image/png "access plus 30 days"
        ExpiresByType image/gif "access plus 30 days"
        ExpiresByType image/svg+xml "access plus 30 days"
        ExpiresByType image/x-icon "access plus 30 days"

        # フォントファイル：1年間
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"

        # JSON：1時間
        ExpiresByType application/json "access plus 1 hour"
    </IfModule>

    <IfModule mod_headers.c>
        # CSS/JSファイルにキャッシュヘッダーを追加
        <FilesMatch "\.(css|js)$">
            Header set Cache-Control "public, max-age=604800, immutable"
        </FilesMatch>

        # 画像ファイルにキャッシュヘッダーを追加
        <FilesMatch "\.(jpg|jpeg|png|gif|svg|ico)$">
            Header set Cache-Control "public, max-age=2592000"
        </FilesMatch>

        # HTMLファイルはキャッシュしない
        <FilesMatch "\.(html|htm)$">
            Header set Cache-Control "no-cache, no-store, must-revalidate"
            Header set Pragma "no-cache"
            Header set Expires "0"
        </FilesMatch>
    </IfModule>

    # ============================================
    # ファイルアップロードサイズ制限
    # ============================================

    # 最大10MB（必要に応じて変更）
    LimitRequestBody 10485760

    # ============================================
    # ログ設定
    # ============================================

    # エラーログ
    ErrorLog ${APACHE_LOG_DIR}/appsuite-itsm-error.log
    LogLevel warn

    # アクセスログ（combined形式）
    CustomLog ${APACHE_LOG_DIR}/appsuite-itsm-access.log combined

    # SSL専用のアクセスログ（オプション）
    # CustomLog ${APACHE_LOG_DIR}/appsuite-itsm-ssl-access.log "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"

    # ============================================
    # 隠しファイルへのアクセス禁止（セキュリティ強化）
    # ============================================

    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>

    # .gitディレクトリへのアクセス禁止
    <DirectoryMatch "\.git">
        Require all denied
    </DirectoryMatch>

    # 設定ファイルへのアクセス禁止
    <FilesMatch "\.(conf|config|json|log|bak|sql|md)$">
        <RequireAll>
            Require all denied
        </RequireAll>
    </FilesMatch>

</VirtualHost>

# ============================================
# グローバル設定
# ============================================

# Serverトークンの最小化（バージョン情報非表示）
ServerTokens Prod
ServerSignature Off

# ============================================
# 使用方法
# ============================================
#
# 1. 設定ファイルをコピー:
#    sudo cp config/apache/appsuite-itsm.conf /etc/apache2/sites-available/
#
# 2. 必要なモジュールを有効化:
#    sudo a2enmod ssl headers rewrite deflate expires
#
# 3. サイトを有効化:
#    sudo a2ensite appsuite-itsm.conf
#
# 4. 設定をテスト:
#    sudo apache2ctl configtest
#
# 5. Apacheを再起動:
#    sudo systemctl restart apache2
#
# 6. 動作確認:
#    curl -I https://appsuite-itsm.example.com/
#
# ============================================
