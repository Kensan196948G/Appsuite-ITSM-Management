# ============================================
# AppSuite ITSM Management System
# Nginx Server Configuration
# ============================================
#
# このファイルをNginxのsites-availableディレクトリにコピーしてください：
# sudo cp config/nginx/appsuite-itsm.conf /etc/nginx/sites-available/
# sudo ln -s /etc/nginx/sites-available/appsuite-itsm.conf /etc/nginx/sites-enabled/
# sudo systemctl reload nginx
#
# ============================================

# ============================================
# HTTP → HTTPS リダイレクト（ポート80）
# ============================================
server {
    # ポート80でリッスン
    listen 80;
    listen [::]:80;

    # サーバー名（実際のIPアドレス）
    server_name 172.23.10.109;

    # ログファイル
    access_log /var/log/nginx/appsuite-itsm-http-access.log;
    error_log /var/log/nginx/appsuite-itsm-http-error.log;

    # すべてのHTTPリクエストをHTTPSにリダイレクト
    return 301 https://$server_name$request_uri;
}

# ============================================
# HTTPS設定（ポート443）
# ============================================
server {
    # ポート443でリッスン（HTTP/2対応）
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # サーバー名（実際のIPアドレス）
    server_name 172.23.10.109;

    # ドキュメントルート（実際のパス）
    root /mnt/LinuxHDD/Appsuite-ITSM-Management/WebUI-Production;

    # デフォルトファイル
    index index.html;

    # ============================================
    # SSL/TLS設定
    # ============================================

    # SSL証明書のパス（自己署名証明書）
    ssl_certificate /mnt/LinuxHDD/Appsuite-ITSM-Management/ssl/prod-cert.pem;
    ssl_certificate_key /mnt/LinuxHDD/Appsuite-ITSM-Management/ssl/prod-key.pem;

    # Let's Encryptの場合（本番環境で推奨）:
    # ssl_certificate /etc/letsencrypt/live/appsuite-itsm.example.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/appsuite-itsm.example.com/privkey.pem;

    # TLS 1.2以上のみ許可（TLS 1.0/1.1は脆弱性のため無効化）
    ssl_protocols TLSv1.2 TLSv1.3;

    # 強固な暗号化スイート（推奨設定）
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';

    # サーバー側の暗号スイート優先
    ssl_prefer_server_ciphers on;

    # SSL セッションキャッシュ
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # DH パラメータ（事前に生成が必要）
    # sudo openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048
    # ssl_dhparam /etc/nginx/ssl/dhparam.pem;

    # OCSP Stapling（証明書の検証を高速化）
    # 自己署名証明書では不要（Let's Encrypt使用時に有効化）
    # ssl_stapling on;
    # ssl_stapling_verify on;
    # ssl_trusted_certificate /etc/letsencrypt/live/appsuite-itsm.example.com/chain.pem;
    # resolver 8.8.8.8 8.8.4.4 valid=300s;
    # resolver_timeout 5s;

    # ============================================
    # セキュリティヘッダー（7種類）
    # ============================================

    # 1. HSTS (HTTP Strict Transport Security)
    #    - 1年間HTTPSのみでアクセスさせる
    #    - サブドメインにも適用
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # 2. Content Security Policy (CSP)
    #    - XSS攻撃・インジェクション攻撃を防止
    #    - 許可するリソース元を制限
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data:; font-src 'self' https://cdnjs.cloudflare.com; connect-src 'self'; frame-ancestors 'self'; base-uri 'self'; form-action 'self'" always;

    # 3. X-Content-Type-Options
    #    - MIMEタイプスニッフィングを防止
    add_header X-Content-Type-Options "nosniff" always;

    # 4. X-Frame-Options
    #    - クリックジャッキング攻撃を防止
    #    - 同一オリジンのみフレーム表示を許可
    add_header X-Frame-Options "SAMEORIGIN" always;

    # 5. Referrer-Policy
    #    - リファラー情報の漏洩を制限
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # 6. Permissions-Policy
    #    - 不要なブラウザAPIへのアクセスを制限
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), accelerometer=(), gyroscope=()" always;

    # 7. X-XSS-Protection
    #    - XSS攻撃を防止（旧ブラウザ対応）
    add_header X-XSS-Protection "1; mode=block" always;

    # Serverヘッダーの削除（バージョン情報の非表示）
    server_tokens off;
    more_clear_headers Server;

    # ============================================
    # Gzip圧縮（パフォーマンス向上）
    # ============================================

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";

    # ============================================
    # ブラウザキャッシュ設定
    # ============================================

    # HTMLファイル：キャッシュしない
    location ~* \.html?$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
    }

    # CSS/JSファイル：7日間キャッシュ
    location ~* \.(css|js)$ {
        expires 7d;
        add_header Cache-Control "public, max-age=604800, immutable";
        access_log off;
    }

    # 画像ファイル：30日間キャッシュ
    location ~* \.(jpg|jpeg|png|gif|svg|ico)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        access_log off;
    }

    # フォントファイル：1年間キャッシュ
    location ~* \.(woff|woff2|ttf|otf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000";
        access_log off;
    }

    # JSONファイル：1時間キャッシュ
    location ~* \.json$ {
        expires 1h;
        add_header Cache-Control "public, max-age=3600";
    }

    # ============================================
    # SPA (Single Page Application) 対応
    # ============================================

    # メインロケーション
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ============================================
    # 静的リソースへのアクセス設定
    # ============================================

    location /css {
        alias /var/www/appsuite-itsm/css;
    }

    location /js {
        alias /var/www/appsuite-itsm/js;
    }

    # ============================================
    # セキュリティ設定（アクセス制限）
    # ============================================

    # 隠しファイル（.で始まるファイル）へのアクセス禁止
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # .gitディレクトリへのアクセス禁止
    location ~ /\.git {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 設定ファイルへのアクセス禁止
    location ~* \.(conf|config|log|bak|sql|md)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ============================================
    # ファイルアップロードサイズ制限
    # ============================================

    # 最大10MB（必要に応じて変更）
    client_max_body_size 10M;

    # ============================================
    # ログ設定
    # ============================================

    # アクセスログ（combined形式）
    access_log /var/log/nginx/appsuite-itsm-access.log combined;

    # エラーログ
    error_log /var/log/nginx/appsuite-itsm-error.log warn;

    # ============================================
    # レート制限（DoS攻撃対策）
    # ============================================

    # ログインエンドポイント等に適用（必要に応じて設定）
    # limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;
    # location /api/login {
    #     limit_req zone=login_limit burst=3 nodelay;
    #     proxy_pass http://backend;
    # }

    # ============================================
    # タイムアウト設定
    # ============================================

    client_body_timeout 12s;
    client_header_timeout 12s;
    keepalive_timeout 15s;
    send_timeout 10s;

    # ============================================
    # バッファサイズ設定
    # ============================================

    client_body_buffer_size 10K;
    client_header_buffer_size 1k;
    large_client_header_buffers 2 1k;

}

# ============================================
# グローバル設定（nginx.confに追加する内容）
# ============================================
#
# http {
#     # Serverトークンの無効化
#     server_tokens off;
#
#     # リクエストヘッダーのサイズ制限
#     client_header_buffer_size 1k;
#     large_client_header_buffers 4 8k;
#
#     # ボディサイズ制限
#     client_max_body_size 10m;
#
#     # タイムアウト設定
#     client_body_timeout 12;
#     client_header_timeout 12;
#     keepalive_timeout 15;
#     send_timeout 10;
# }

# ============================================
# 使用方法
# ============================================
#
# 1. 設定ファイルをコピー:
#    sudo cp config/nginx/appsuite-itsm.conf /etc/nginx/sites-available/
#
# 2. シンボリックリンクを作成:
#    sudo ln -s /etc/nginx/sites-available/appsuite-itsm.conf /etc/nginx/sites-enabled/
#
# 3. 設定をテスト:
#    sudo nginx -t
#
# 4. Nginxを再起動:
#    sudo systemctl restart nginx
#
# 5. 動作確認:
#    curl -I https://appsuite-itsm.example.com/
#
# ============================================
