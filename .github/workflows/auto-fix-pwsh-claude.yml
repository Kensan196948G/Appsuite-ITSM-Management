name: Auto Fix Loop (PowerShell + Claude Code)

on:
  push:
    branches: [main, master]
    paths:
      - '**.ps1'
      - 'build.ps1'
      - '.github/workflows/auto-fix-pwsh-claude.yml'
  workflow_dispatch:
    inputs:
      max_iterations:
        description: 'Maximum fix iterations'
        required: false
        default: '5'
  pull_request:
    branches: [main, master]
    paths:
      - '**.ps1'

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  MAX_ITERATIONS: ${{ github.event.inputs.max_iterations || '5' }}

jobs:
  build-and-fix:
    runs-on: ubuntu-latest  # Changed from self-hosted for compatibility
    timeout-minutes: 30

    steps:
      # ========================================
      # Step 1: „ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      # ========================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ========================================
      # Step 2: PowerShell 7+ „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
      # ========================================
      - name: Setup PowerShell 7
        run: |
          echo "========================================"
          echo "üîß PowerShell Setup"
          echo "========================================"
          pwsh -Command '$PSVersionTable'
          echo ""

      # ========================================
      # Step 3: Node.js „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÔºàESLintÁî®Ôºâ
      # ========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: |
          npm ci || npm install
          npm install -g eslint prettier

      # ========================================
      # Step 4: „É´„Éº„Éó„Ç¨„Éº„ÉâÂàùÊúüÂåñ
      # ========================================
      - name: Initialize Loop Guard
        id: loop-guard-init
        run: |
          echo "Resetting loop guard counters..."
          rm -f .ci_attempt .ci_error_hash .ci_consecutive_failures
          echo "‚úÖ Loop guard initialized"

      # ========================================
      # Step 5: „Éì„É´„ÉâÂÆüË°åÔºàPowerShellÔºâ
      # ========================================
      - name: Build (PowerShell)
        id: build
        run: |
          set -o pipefail
          echo "========================================"
          echo "üèóÔ∏è  Running build.ps1"
          echo "========================================"
          pwsh ./build.ps1 2>&1 | tee build.log
        continue-on-error: true

      # ========================================
      # Step 6: „Éì„É´„Éâ„É≠„Ç∞„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      # ========================================
      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ github.run_number }}
          path: build.log
          retention-days: 30

      # ========================================
      # Step 7: „É´„Éº„Éó„Ç¨„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
      # ========================================
      - name: Loop Guard Check
        if: steps.build.outcome == 'failure'
        id: loop-guard
        run: bash ./ci/loop-guard.sh
        env:
          MAX_ATTEMPTS: ${{ env.MAX_ITERATIONS }}
          BUILD_LOG: build.log

      # ========================================
      # Step 8: Claude Code Ëá™Âãï‰øÆÂæ©
      # ========================================
      - name: Auto-fix with Claude Code
        if: steps.build.outcome == 'failure' && steps.loop-guard.outcome == 'success'
        id: auto-fix
        run: bash ./ci/auto_fix_with_claudecode.sh
        env:
          PROJECT_ROOT: ${{ github.workspace }}
          BUILD_LOG: build.log

      # ========================================
      # Step 9: ‰øÆÊ≠£ÂÜÖÂÆπ„ÅÆ„Ç≥„Éü„ÉÉ„Éà & „Éó„ÉÉ„Ç∑„É•
      # ========================================
      - name: Commit and Push fixes
        if: steps.build.outcome == 'failure' && steps.auto-fix.outcome == 'success'
        id: commit-fixes
        run: |
          git config user.name "ci-bot[bot]"
          git config user.email "ci-bot[bot]@users.noreply.github.com"

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "changes_committed=false" >> $GITHUB_OUTPUT
          else
            TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S UTC")
            ATTEMPT=$(cat .ci_attempt 2>/dev/null || echo 0)
            git commit -m "ci: auto-fix PowerShell build failure (Iteration $ATTEMPT)"
            git push
            echo "changes_committed=true" >> $GITHUB_OUTPUT
          fi

      # ========================================
      # Step 10: CI Logs„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      # ========================================
      - name: Upload CI logs (Ë®ºË∑°)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-${{ github.run_number }}
          path: ci_logs/
          retention-days: 90  # ITSMÁõ£ÊüªÂØæÂøú„ÅÆ„Åü„ÇÅÈï∑Êúü‰øùÂ≠ò

      # ========================================
      # Step 11: ÊàêÂäüÊôÇ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
      # ========================================
      - name: Cleanup on success
        if: steps.build.outcome == 'success'
        run: |
          echo "Build succeeded! Resetting loop guard."
          rm -f .ci_attempt .ci_error_hash .ci_consecutive_failures
          echo "0" > .ci_consecutive_failures

      # ========================================
      # Step 12: „Çµ„Éû„É™„ÉºÁîüÊàê
      # ========================================
      - name: Generate Summary
        if: always()
        run: |
          echo "## ü§ñ Auto Fix Loop Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.build.outcome }}" = "success" ]; then
            echo "### ‚úÖ Build Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Build Status: FAILURE" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Outcome | ${{ steps.build.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Loop Guard | ${{ steps.loop-guard.outcome || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Auto Fix | ${{ steps.auto-fix.outcome || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Changes Committed | ${{ steps.commit-fixes.outputs.changes_committed || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ATTEMPT=$(cat .ci_attempt 2>/dev/null || echo 0)
          echo "| Iteration | $ATTEMPT / ${{ env.MAX_ITERATIONS }} |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÑ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Build Log: \`build-log-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- CI Logs (Ë®ºË∑°): \`ci-logs-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY

      # ========================================
      # Step 13: Issue‰ΩúÊàêÔºàÂ§±ÊïóÊôÇÔºâ
      # ========================================
      - name: Create Issue on repeated failure
        if: failure() && steps.loop-guard.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const body = '## CI Auto-Fix Loop Failure\n\n' +
              'The automated build repair has failed after ${{ env.MAX_ITERATIONS }} attempts.\n\n' +
              '### Details\n' +
              '- Run ID: ${{ github.run_id }}\n' +
              '- Branch: ${{ github.ref_name }}\n' +
              '- Commit: ${{ github.sha }}\n\n' +
              '### Next Steps\n' +
              '1. Review build.log in artifacts\n' +
              '2. Fix the issue manually\n';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'CI Auto-Fix Loop Failed (Max Attempts Reached)',
              body: body,
              labels: ['ci-failure', 'needs-manual-review']
            });
