name: Auto Error Detection and Fix Loop

on:
  # 30åˆ†é–“éš”ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
  schedule:
    - cron: '*/30 * * * *'
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:
    inputs:
      max_iterations:
        description: 'Maximum fix iterations'
        required: false
        default: '15'
  # ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«ã‚‚å®Ÿè¡Œ
  push:
    branches: [main, master]

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  MAX_ITERATIONS: ${{ github.event.inputs.max_iterations || '15' }}

jobs:
  auto-fix-loop:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci || npm install
          npm install -g eslint prettier

      - name: Run Tests
        id: test-run
        run: |
          echo "Running automated tests..."
          npm test
          TEST_EXIT_CODE=$?
          echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ Tests failed with exit code $TEST_EXIT_CODE"
          else
            echo "âœ… All tests passed"
          fi

      - name: Auto Fix Loop
        id: fix-loop
        run: |
          echo "Starting Auto Fix Loop (Max iterations: $MAX_ITERATIONS)"

          ITERATION=0
          FIXED_COUNT=0
          ERROR_LOG=""

          while [ $ITERATION -lt $MAX_ITERATIONS ]; do
            ITERATION=$((ITERATION + 1))
            echo "=== Iteration $ITERATION / $MAX_ITERATIONS ==="

            # Step 1: ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥
            echo "Step 1: Detecting errors..."
            ERRORS_FOUND=false

            # ESLint ãƒã‚§ãƒƒã‚¯
            if npx eslint WebUI-Production/js/*.js --format json > eslint-report.json 2>/dev/null; then
              ESLINT_ERRORS=$(cat eslint-report.json | jq '[.[] | .errorCount] | add // 0')
              if [ "$ESLINT_ERRORS" -gt 0 ]; then
                echo "ESLint errors found: $ESLINT_ERRORS"
                ERRORS_FOUND=true
              fi
            else
              echo "ESLint check failed, attempting fix..."
              ERRORS_FOUND=true
            fi

            # HTML ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if command -v html-validate &> /dev/null; then
              if ! html-validate WebUI-Production/*.html 2>/dev/null; then
                echo "HTML validation errors found"
                ERRORS_FOUND=true
              fi
            fi

            # CSS ãƒã‚§ãƒƒã‚¯
            if command -v stylelint &> /dev/null; then
              if ! stylelint "**/*.css" --allow-empty-input 2>/dev/null; then
                echo "CSS errors found"
                ERRORS_FOUND=true
              fi
            fi

            # ã‚¨ãƒ©ãƒ¼ãŒãªã‘ã‚Œã°ãƒ«ãƒ¼ãƒ—çµ‚äº†
            if [ "$ERRORS_FOUND" = false ]; then
              echo "No errors found! Loop completed successfully."
              break
            fi

            # Step 2: è‡ªå‹•ä¿®å¾©
            echo "Step 2: Auto-fixing errors..."

            # ESLint è‡ªå‹•ä¿®å¾©
            npx eslint WebUI-Production/js/*.js --fix 2>/dev/null || true

            # Prettier ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            npx prettier --write "WebUI-Production/**/*.{js,css,html}" 2>/dev/null || true

            FIXED_COUNT=$((FIXED_COUNT + 1))

            # Step 3: ç¢ºèª
            echo "Step 3: Verifying fixes..."

            # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if git diff --quiet; then
              echo "No changes made in this iteration"
            else
              echo "Changes detected, will commit later"
            fi

            echo "Iteration $ITERATION completed"
            echo "---"
          done

          echo "fix_iterations=$ITERATION" >> $GITHUB_OUTPUT
          echo "fixed_count=$FIXED_COUNT" >> $GITHUB_OUTPUT

      - name: Security Vulnerability Check
        id: security-check
        continue-on-error: true
        run: |
          echo "Checking for security vulnerabilities..."

          # npm audit
          npm audit --json > audit-report.json 2>/dev/null || true

          VULNERABILITIES=$(cat audit-report.json | jq '.metadata.vulnerabilities.total // 0' 2>/dev/null || echo "0")
          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT

          # è„†å¼±æ€§ãŒã‚ã‚Œã°è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œ
          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "Found $VULNERABILITIES vulnerabilities, attempting auto-fix..."
            npm audit fix --force 2>/dev/null || true
          fi

      - name: Commit and Push Changes
        id: commit-changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸
          git add -A

          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "changes_committed=false" >> $GITHUB_OUTPUT
          else
            TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "fix: Auto-fix errors (iterations: ${{ steps.fix-loop.outputs.fix_iterations }})"
            git push
            echo "changes_committed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create/Update Issue Report
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸ”„ Auto Fix Loop Report';
            const timestamp = new Date().toISOString();
            const iterations = '${{ steps.fix-loop.outputs.fix_iterations }}' || '0';
            const vulnerabilities = '${{ steps.security-check.outputs.vulnerabilities }}' || '0';
            const changesCommitted = '${{ steps.commit-changes.outputs.changes_committed }}' === 'true';

            const body = `## Auto Fix Loop Report

            **Timestamp:** ${timestamp}
            **Status:** ${changesCommitted ? 'âœ… Changes committed' : 'â„¹ï¸ No changes needed'}

            ### Summary
            | Metric | Value |
            |--------|-------|
            | Fix Iterations | ${iterations} / ${{ env.MAX_ITERATIONS }} |
            | Security Vulnerabilities | ${vulnerabilities} |
            | Changes Committed | ${changesCommitted ? 'Yes' : 'No'} |

            ### Next Scheduled Run
            This workflow runs every 30 minutes automatically.

            ---
            *Generated by GitHub Actions*`;

            // æ—¢å­˜ã®Issueã‚’æ¤œç´¢
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-fix-report'
            });

            if (issues.data.length > 0) {
              // æ—¢å­˜ã®Issueã‚’æ›´æ–°
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });

              // ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `### Update - ${timestamp}\n- Iterations: ${iterations}\n- Vulnerabilities: ${vulnerabilities}\n- Changes: ${changesCommitted ? 'Yes' : 'No'}`
              });
            } else {
              // æ–°ã—ã„Issueã‚’ä½œæˆ
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['auto-fix-report', 'automated']
              });
            }

      - name: Summary
        if: always()
        run: |
          echo "## Auto Fix Loop Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test Result | ${{ steps.test-run.outputs.test_exit_code == '0' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Iterations | ${{ steps.fix-loop.outputs.fix_iterations }} / ${{ env.MAX_ITERATIONS }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Vulnerabilities | ${{ steps.security-check.outputs.vulnerabilities }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Changes Committed | ${{ steps.commit-changes.outputs.changes_committed }} |" >> $GITHUB_STEP_SUMMARY

  # å†ãƒˆãƒªã‚¬ãƒ¼ç”¨ã‚¸ãƒ§ãƒ–ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿç¾ï¼‰
  re-trigger:
    needs: auto-fix-loop
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Wait and Re-trigger
        run: |
          echo "Workflow completed. Next scheduled run in ~30 minutes."
          echo "The cron schedule (*/30 * * * *) ensures continuous execution."
