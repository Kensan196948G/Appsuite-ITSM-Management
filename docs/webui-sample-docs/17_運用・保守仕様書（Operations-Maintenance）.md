# 運用・保守仕様書（Operations & Maintenance Specification）

**ドキュメントID:** WUI-OPS-001
**プロジェクト名:** WebUI サンプルシステム
**バージョン:** 1.0.0
**作成日:** 2026-02-25
**最終更新日:** 2026-02-25
**ステータス:** Draft

---

## 1. SLA（サービスレベル合意）

### 1.1 可用性目標

| 指標 | 目標値 | 計測方法 |
|------|-------|---------|
| 月次稼働率 | 99.9%（月次ダウンタイム 43分以内） | 外形監視 |
| 計画メンテナンス | 月1回・深夜2時〜4時（通知1週間前） | - |
| 障害復旧時間（MTTR） | 2時間以内（重大障害） | インシデント記録 |
| データ損失許容時間（RPO） | 1時間以内 | バックアップログ |

### 1.2 応答時間目標（本番稼働中）

| 指標 | 目標 |
|------|------|
| 通常時 API P95 | < 500ms |
| ピーク時 API P95 | < 1000ms |
| 画面ロード時間 LCP | < 2.5秒 |

---

## 2. 監視設計

### 2.1 監視ツール構成

```
[本番環境]
    │
    ├── [外形監視] Uptime Robot
    │     ・5分毎にURLをチェック
    │     ・ダウン時にSlack/メールで通知
    │
    ├── [APM] Datadog
    │     ・APIレスポンス時間
    │     ・エラー率
    │     ・スループット
    │
    ├── [フロントエンド監視] Sentry
    │     ・JSエラーの自動キャプチャ
    │     ・パフォーマンストレース
    │
    ├── [インフラ監視] CloudWatch
    │     ・CPU/メモリ使用率
    │     ・ECSタスク状態
    │     ・RDSメトリクス
    │
    └── [ログ管理] CloudWatch Logs
          ・アプリケーションログ
          ・アクセスログ
          ・エラーログ
```

### 2.2 アラート定義

| アラート名 | 条件 | 重大度 | 通知先 | 対応SLA |
|---------|------|-------|-------|--------|
| サービス停止 | 外形監視 3回連続失敗 | Critical | 当番エンジニア（電話） | 15分以内 |
| エラー率急増 | エラー率 > 5%（5分間） | High | Slack #alert | 30分以内 |
| APIレスポンス遅延 | P95 > 2000ms（5分間） | High | Slack #alert | 1時間以内 |
| CPU高負荷 | CPU > 90%（10分間） | Medium | Slack #ops | 2時間以内 |
| DB接続枯渇 | 接続数 > 95% | High | Slack #alert | 30分以内 |
| ストレージ逼迫 | 使用率 > 85% | Medium | Slack #ops | 翌営業日 |
| SSL証明書期限 | 30日前 | Low | メール | 1週間以内 |

---

## 3. ログ管理

### 3.1 ログレベルと用途

| レベル | 用途 | 本番出力 |
|-------|------|---------|
| ERROR | 復旧が必要な障害 | ✅ |
| WARN | 注意が必要な状況 | ✅ |
| INFO | 重要な業務イベント | ✅ |
| DEBUG | 開発・調査用詳細情報 | ❌ |
| TRACE | 詳細トレース情報 | ❌ |

### 3.2 構造化ログフォーマット

```json
{
  "timestamp": "2026-02-25T10:00:00.000Z",
  "level": "ERROR",
  "service": "webui-frontend",
  "environment": "production",
  "requestId": "req_abc123",
  "userId": "usr_001",
  "message": "API呼び出しに失敗しました",
  "error": {
    "code": "INTERNAL_ERROR",
    "message": "Internal Server Error",
    "stack": "..."
  },
  "context": {
    "endpoint": "/api/v1/items",
    "method": "GET",
    "duration": 5230
  }
}
```

### 3.3 ログ保存期間

| ログ種別 | 保存期間 | 保存先 |
|---------|---------|-------|
| アプリケーションログ | 30日（ホット） / 1年（コールド） | CloudWatch / S3 |
| アクセスログ | 90日 | CloudWatch |
| エラーログ | 1年 | CloudWatch / S3 |
| 監査ログ | 5年 | S3（Glacier） |

---

## 4. バックアップ・リストア

### 4.1 バックアップ方針

| 対象 | バックアップ頻度 | 保存期間 | 方法 |
|------|-------------|---------|------|
| PostgreSQL（フルバックアップ） | 毎日 02:00 UTC | 7日間 | RDS 自動バックアップ |
| PostgreSQL（差分バックアップ） | 5分毎 | 7日間 | RDS PITR |
| S3ファイルストレージ | リアルタイム | 30日間 | S3 バージョニング |
| Redisキャッシュ | バックアップ不要 | - | 揮発性データ |

### 4.2 リストア手順

**PostgreSQL PITR（ポイントインタイムリカバリ）:**
```bash
# 1. RDS コンソールで復元ポイントを選択
# 2. 新しい DB インスタンスとして復元
aws rds restore-db-instance-to-point-in-time \
  --source-db-instance-identifier production-db \
  --target-db-instance-identifier production-db-restored \
  --restore-time 2026-02-25T09:00:00Z

# 3. 接続先を新インスタンスに切り替え（アプリ設定変更）
# 4. 動作確認後、元インスタンスを削除
```

---

## 5. インシデント対応

### 5.1 重大度分類

| 重大度 | 影響範囲 | 例 | 対応時間 |
|-------|---------|-----|---------|
| P1 Critical | サービス全停止 | ログイン不可・全ページ404 | 15分以内に対応開始 |
| P2 High | 主要機能障害 | データ保存不可・大幅遅延 | 1時間以内 |
| P3 Medium | 部分的な機能障害 | 一部フィルター不動作 | 翌営業日 |
| P4 Low | 軽微な不具合 | UI表示崩れ | 次回リリース |

### 5.2 インシデント対応フロー

```
[アラート発報 / ユーザー報告]
         │
         ▼
   [初期トリアージ]
   ・影響範囲の確認
   ・重大度の判定
         │
    ┌────┴────┐
    │P1/P2    │P3/P4
    ▼         ▼
[インシデント宣言]  [通常チケット化]
[オンコール召集]
    │
    ▼
[原因調査・暫定対処]
・ロールバック検討
・トラフィック切り替え
    │
    ▼
[恒久対策実装・リリース]
    │
    ▼
[事後レビュー（ポストモーテム）]
・タイムライン整理
・根本原因分析
・再発防止策策定
```

### 5.3 インシデント通知テンプレート

**発生時（Slack #incidents）:**
```
🚨 [P1 INCIDENT] サービス障害発生
発生時刻: 2026-02-25 10:30 JST
影響: ログインができない状態
対応中: @engineer-name
ステータス更新: 15分毎
```

**復旧時:**
```
✅ [RESOLVED] サービス復旧
復旧時刻: 2026-02-25 11:15 JST
ダウンタイム: 45分
原因: DBコネクションプールの枯渇
恒久対策: 次回スプリントで対応
```

---

## 6. 定期メンテナンス

### 6.1 定期作業スケジュール

| 作業 | 頻度 | 担当 | 所要時間 |
|------|------|------|---------|
| 依存パッケージ更新（セキュリティパッチ） | 月次 | 開発チーム | 2-4時間 |
| SSL証明書更新 | 自動（Let's Encrypt） | - | - |
| DB統計情報更新（VACUUM ANALYZE） | 週次（自動） | - | - |
| ログのアーカイブ | 月次（自動） | - | - |
| バックアップリストアテスト | 四半期 | 運用担当 | 2時間 |
| セキュリティスキャン（OWASP ZAP） | 月次 | セキュリティ担当 | 4時間 |
| DR訓練（障害復旧演習） | 半年 | 全担当 | 半日 |

### 6.2 メンテナンスウィンドウ通知

ユーザーへの事前通知は以下のタイミングで行う。

- **計画メンテナンス:** 1週間前・1日前・30分前
- **緊急メンテナンス:** 可能な限り早く（最低1時間前）
- **通知チャネル:** システム内バナー、メール、ステータスページ

---

## 7. 容量計画

### 7.1 成長予測

| 指標 | 現在 | 6ヶ月後 | 1年後 |
|------|------|--------|-------|
| 月間アクティブユーザー | 100 | 300 | 500 |
| データレコード数 | 10,000 | 50,000 | 100,000 |
| ストレージ使用量 | 10GB | 50GB | 100GB |

### 7.2 スケーリング基準

- **ECS Auto Scaling:** CPU使用率 > 70% でタスク追加
- **RDS スケールアップ:** CPU 80%超が1時間以上続く場合
- **S3:** 自動スケール（制限なし）

---

## 8. 改訂履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|---------|--------|
| 1.0.0 | 2026-02-25 | 初版作成 | システム管理者 |
