# ロールバック手順書

**文書番号**: RBK-APPSUITE-001
**バージョン**: 1.0
**作成日**: 2026年2月4日
**対象システム**: AppSuite管理運用システム

---

## 目次

1. [概要](#1-概要)
2. [ロールバック判断基準](#2-ロールバック判断基準)
3. [緊急ロールバック手順](#3-緊急ロールバック手順)
4. [計画的ロールバック手順](#4-計画的ロールバック手順)
5. [ロールバック後の対応](#5-ロールバック後の対応)
6. [トラブルシューティング](#6-トラブルシューティング)

---

## 1. 概要

### 1.1 目的

本書は、デプロイ後に重大な問題が発生した場合、システムを安全かつ迅速に前バージョンに戻すための手順を提供する。

### 1.2 ロールバックの種類

| 種別 | 実施タイミング | 所要時間 | 対象 |
|------|--------------|---------|------|
| **緊急ロールバック** | 重大障害発生時（即座） | 15分以内 | 本番環境 |
| **計画的ロールバック** | 軽微な問題発見時 | 30分以内 | 本番環境 |
| **練習ロールバック** | リハーサル時 | 制限なし | ステージング環境 |

### 1.3 前提条件

- [ ] デプロイ時にバックアップが取得されている
- [ ] バックアップファイルの場所が把握されている
- [ ] サーバーへのSSHアクセス権限がある
- [ ] 緊急連絡先を把握している

### 1.4 バックアップファイルの場所

```bash
# 本番環境のバックアップ
/var/backups/appsuite-itsm/production_backup_YYYYMMDD_HHMMSS.tar.gz

# ステージング環境のバックアップ
/var/backups/appsuite-itsm/staging_backup_YYYYMMDD_HHMMSS.tar.gz
```

---

## 2. ロールバック判断基準

### 2.1 即座にロールバックが必要な状況（重大）

以下のいずれかに該当する場合、**即座にロールバック**を実施する。

| No. | 状況 | 影響 | 判断者 |
|-----|------|------|--------|
| 1 | **システム全体が起動しない** | 全ユーザーがアクセス不可 | PM + インフラ |
| 2 | **データ消失・破損が発生** | データ整合性の問題 | PM（即決） |
| 3 | **セキュリティ脆弱性の発見** | 情報漏洩リスク | PM + セキュリティ担当 |
| 4 | **主要機能が全て動作しない** | ダッシュボード・ユーザー管理等 | PM |
| 5 | **認証機能が動作しない** | ログイン不可 | PM |

### 2.2 ロールバックを検討すべき状況（高）

以下に該当する場合、**1時間以内にロールバック判断**を行う。

| No. | 状況 | 影響 | 判断者 |
|-----|------|------|--------|
| 1 | **一部の主要機能が動作しない** | インシデント管理・変更管理等 | PM + 技術リード |
| 2 | **性能が著しく劣化** | 表示速度が10秒以上 | PM + 技術リード |
| 3 | **複数ユーザーから不具合報告** | 3件以上の類似報告 | PM |
| 4 | **エラーログが大量発生** | 10件/分以上のエラー | PM + 開発リード |

### 2.3 回避策で対応可能な状況（中）

以下に該当する場合、**ロールバックは不要**（修正対応）

| No. | 状況 | 対応 |
|-----|------|------|
| 1 | 軽微なUI表示の問題 | CSS修正で対応 |
| 2 | 一部機能の小さなバグ | ホットフィックスで対応 |
| 3 | 特定条件下でのエラー | 回避策を案内 |

### 2.4 ロールバック判断フロー

```
問題発生
  ↓
影響度評価（5分）
  ├─ 重大 → 即座にロールバック実施
  ├─ 高   → PM判断（1時間以内）
  │         ├─ ロールバック実施
  │         └─ 修正対応
  └─ 中/低 → 修正対応
```

---

## 3. 緊急ロールバック手順

**実施条件**: 重大障害発生時
**所要時間**: 15分以内
**担当**: インフラ担当、BE開発者
**承認**: PM（口頭承認可）

### 3.1 緊急連絡

```bash
# ========================================
# Step 0: 緊急連絡
# ========================================
# PMへ即座に連絡
# - 電話: 090-xxxx-xxxx
# - チャット: 緊急チャンネル

# 連絡内容:
# 1. 発生時刻
# 2. 問題の内容
# 3. 影響範囲
# 4. ロールバック実施予定時刻
```

### 3.2 ロールバック実行

```bash
# ========================================
# Step 1: 本番サーバーへSSH接続
# ========================================
ssh user@appsuite-itsm.example.com

# ========================================
# Step 2: 最新バックアップの確認
# ========================================
ls -lt /var/backups/appsuite-itsm/ | head -n 5

# 最新バックアップのファイル名を確認
BACKUP_FILE=$(ls -t /var/backups/appsuite-itsm/production_backup_*.tar.gz | head -n 1)

echo "ロールバック対象バックアップ: $BACKUP_FILE"

# バックアップファイルが存在するか確認
if [ ! -f "$BACKUP_FILE" ]; then
    echo "ERROR: バックアップファイルが見つかりません"
    echo "PMに連絡してください"
    exit 1
fi

# ファイルサイズ確認（0バイトでないことを確認）
ls -lh "$BACKUP_FILE"

# ========================================
# Step 3: 現在のバージョンを退避
# ========================================
ROLLBACK_DATE=$(date +%Y%m%d_%H%M%S)

if [ -d "/var/www/html/appsuite-itsm" ]; then
    sudo mv /var/www/html/appsuite-itsm \
        /var/www/html/appsuite-itsm.failed_${ROLLBACK_DATE}
    echo "✓ 失敗バージョンを退避: appsuite-itsm.failed_${ROLLBACK_DATE}"
fi

# ========================================
# Step 4: バックアップからリストア
# ========================================
echo "ロールバック開始: $(date)"

sudo tar -xzf "$BACKUP_FILE" -C /var/www/html/

echo "✓ バックアップから復元完了"

# ========================================
# Step 5: 権限設定
# ========================================
sudo chown -R www-data:www-data /var/www/html/appsuite-itsm
sudo find /var/www/html/appsuite-itsm -type d -exec chmod 755 {} \;
sudo find /var/www/html/appsuite-itsm -type f -exec chmod 644 {} \;

echo "✓ 権限設定完了"

# ========================================
# Step 6: Webサーバー設定確認
# ========================================
# Apache
sudo apache2ctl configtest

# Nginx
sudo nginx -t

# エラーがある場合は修正

# ========================================
# Step 7: Webサーバー再起動
# ========================================
echo "Webサーバー再起動: $(date)"

# Apache
sudo systemctl restart apache2

# Nginx
sudo systemctl restart nginx

# ========================================
# Step 8: 再起動確認
# ========================================
# Apache
sudo systemctl status apache2

# Nginx
sudo systemctl status nginx

# 期待: active (running)

echo "✓ Webサーバー再起動完了"

# ========================================
# Step 9: ロールバック確認
# ========================================
# HTTPSアクセス確認
curl -I https://appsuite-itsm.example.com/

# 期待出力: HTTP/2 200

# ========================================
# Step 10: ロールバック完了ログ
# ========================================
echo "Rollback completed at $(date)" | \
    sudo tee -a /var/log/appsuite-itsm-deploy.log

echo "Rolled back to: $BACKUP_FILE" | \
    sudo tee -a /var/log/appsuite-itsm-deploy.log

echo "ロールバック完了: $(date)"
```

### 3.3 ロールバック確認（5分）

```bash
# ========================================
# 基本動作確認
# ========================================

# 1. HTTPSアクセス確認
curl -I https://appsuite-itsm.example.com/
# 期待: HTTP/2 200 OK

# 2. ダッシュボード表示確認（ブラウザ）
# https://appsuite-itsm.example.com/ にアクセス
# 期待: ダッシュボードが表示される

# 3. エラーログ確認
# Apache
sudo tail -n 50 /var/log/apache2/error.log

# Nginx
sudo tail -n 50 /var/log/nginx/error.log

# 期待: 重大なエラーがないこと
```

### 3.4 緊急通知

```bash
# ========================================
# ロールバック完了の通知
# ========================================

# PMへ報告:
# 1. ロールバック完了時刻
# 2. 復旧確認済み
# 3. 原因調査を開始

# ユーザーへの周知（PMが実施）:
# - 問題が解決したことを通知
# - 一時的に前バージョンで運用中
```

---

## 4. 計画的ロールバック手順

**実施条件**: 軽微な問題が発見され、修正に時間がかかる場合
**所要時間**: 30分以内
**担当**: BE開発者、インフラ担当
**承認**: PM（文書承認）

### 4.1 ロールバック計画

```bash
# ========================================
# Step 1: ロールバック計画書の作成
# ========================================

# 以下の項目を記載:
# 1. ロールバックの理由
# 2. 実施日時（ユーザー影響が少ない時間帯を選定）
# 3. 実施担当者
# 4. ユーザーへの事前通知内容
# 5. 所要時間
```

### 4.2 事前通知

```bash
# ========================================
# Step 2: ユーザーへの事前通知（24時間前）
# ========================================

# 通知内容例:
# 件名: 【重要】システムロールバックのお知らせ
#
# 本文:
# いつもご利用いただきありがとうございます。
#
# 本日のリリースにおいて問題が発見されたため、
# 以下の日時に前バージョンへのロールバックを実施いたします。
#
# ■実施日時
# YYYY年MM月DD日（曜日）HH:MM - HH:MM
#
# ■影響
# 上記時間帯はシステムが一時的に利用できなくなります。
#
# ■対応
# ロールバック完了後、通常通りご利用いただけます。
#
# ご不便をおかけして申し訳ございませんが、
# ご理解のほどよろしくお願いいたします。
```

### 4.3 ロールバック実行

**実施手順**: [3.2 ロールバック実行](#32-ロールバック実行) と同じ

### 4.4 詳細な動作確認

```bash
# ========================================
# 計画的ロールバックの場合、詳細確認を実施
# ========================================

# 1. 全機能の動作確認（チェックリスト使用）
# - ダッシュボード表示
# - ユーザー管理（CRUD）
# - アプリ管理（CRUD）
# - インシデント管理（CRUD）
# - 変更管理（CRUD）
# - 監査ログ
# - システム設定
# - バックアップ/リストア

# 2. 性能確認
time curl -s https://appsuite-itsm.example.com/ > /dev/null
# 期待: real時間が3秒以内

# 3. ログ確認（30分間監視）
sudo tail -f /var/log/apache2/error.log    # Apache
sudo tail -f /var/log/nginx/error.log      # Nginx

# 期待: エラーが発生しないこと
```

### 4.5 完了報告

```bash
# ========================================
# ロールバック完了報告書の作成
# ========================================

# 報告書に含める項目:
# 1. 実施日時
# 2. ロールバック理由
# 3. 実施担当者
# 4. 所要時間
# 5. 動作確認結果
# 6. 今後の対応（修正計画）
```

---

## 5. ロールバック後の対応

### 5.1 原因調査

```bash
# ========================================
# Step 1: ログの収集
# ========================================

# 失敗したバージョンのログを保存
sudo tar -czf /tmp/failed_logs_$(date +%Y%m%d_%H%M%S).tar.gz \
    /var/log/apache2/ \
    /var/log/nginx/ \
    /var/www/html/appsuite-itsm.failed_*/

# ログファイルをローカルにダウンロード
scp user@appsuite-itsm.example.com:/tmp/failed_logs_*.tar.gz ./

# ========================================
# Step 2: 問題の特定
# ========================================

# エラーログの分析
# - どの機能で問題が発生したか
# - エラーメッセージの内容
# - 発生頻度

# ブラウザコンソールログの確認
# - JavaScriptエラーの有無
# - ネットワークエラーの有無

# ========================================
# Step 3: 再現テスト
# ========================================

# ステージング環境で再現確認
# - 同じ条件で問題が再現するか
# - 原因の特定
```

### 5.2 修正と再デプロイ計画

```bash
# ========================================
# Step 1: 修正実施
# ========================================

# 開発環境で修正
# - バグフィックス
# - 単体テスト実施

# ========================================
# Step 2: ステージング環境で検証
# ========================================

# ステージング環境にデプロイ
# - 修正内容の動作確認
# - 回帰テスト実施

# ========================================
# Step 3: 再デプロイ計画
# ========================================

# リリース判定会議で再承認
# - 修正内容の説明
# - テスト結果の報告
# - 再デプロイ日程の決定
```

### 5.3 ユーザーへの報告

```bash
# ========================================
# ロールバック完了の通知
# ========================================

# 通知内容例:
# 件名: 【完了】システムロールバックのご報告
#
# 本文:
# いつもご利用いただきありがとうございます。
#
# 本日HH:MM、システムのロールバックが完了し、
# 通常通りご利用いただけるようになりました。
#
# ■ロールバック理由
# [問題の簡単な説明]
#
# ■今後の対応
# 問題を修正し、改めてリリースを予定しております。
# 詳細が決まり次第、ご案内させていただきます。
#
# ご不便をおかけして申し訳ございませんでした。
```

### 5.4 事後レビュー

```bash
# ========================================
# 振り返りMTG（ロールバック後1-2日以内）
# ========================================

# 議題:
# 1. 問題の原因
# 2. ロールバック対応の評価
#    - 所要時間は適切だったか
#    - 手順に問題はなかったか
# 3. 再発防止策
#    - テストプロセスの改善
#    - デプロイ手順の見直し
# 4. ドキュメントの更新
#    - 本手順書の改善点
#    - トラブルシューティングの追加
```

---

## 6. トラブルシューティング

### 6.1 バックアップファイルが見つからない

**症状**: `/var/backups/appsuite-itsm/` にバックアップファイルが存在しない

**原因**: バックアップの取得漏れ

**対処**:
```bash
# 1. 他の場所を確認
find /var/backups -name "*appsuite*" -type f

# 2. ホームディレクトリを確認
find ~ -name "*appsuite*" -type f

# 3. それでも見つからない場合はPMに連絡
# - 外部バックアップの確認
# - 代替手段の検討
```

### 6.2 バックアップファイルが破損している

**症状**: `tar -xzf` で解凍エラーが発生

**原因**: バックアップファイルの破損

**対処**:
```bash
# 1. ファイルの整合性確認
tar -tzf /var/backups/appsuite-itsm/production_backup_*.tar.gz > /dev/null

# エラーが出る場合は破損

# 2. 前のバックアップを確認
ls -lt /var/backups/appsuite-itsm/

# 2番目に新しいバックアップを使用
BACKUP_FILE=$(ls -t /var/backups/appsuite-itsm/production_backup_*.tar.gz | head -n 2 | tail -n 1)

# 3. それでも復元できない場合はPMに連絡
```

### 6.3 ロールバック後もエラーが発生する

**症状**: ロールバック完了後もシステムが動作しない

**原因**: Webサーバー設定、権限、またはその他の問題

**対処**:
```bash
# 1. Webサーバーの状態確認
sudo systemctl status apache2    # Apache
sudo systemctl status nginx       # Nginx

# 起動していない場合は起動
sudo systemctl start apache2      # Apache
sudo systemctl start nginx        # Nginx

# 2. 権限の確認
ls -la /var/www/html/appsuite-itsm/

# 権限が不正な場合は修正
sudo chown -R www-data:www-data /var/www/html/appsuite-itsm
sudo find /var/www/html/appsuite-itsm -type d -exec chmod 755 {} \;
sudo find /var/www/html/appsuite-itsm -type f -exec chmod 644 {} \;

# 3. エラーログ確認
sudo tail -n 100 /var/log/apache2/error.log    # Apache
sudo tail -n 100 /var/log/nginx/error.log      # Nginx

# 4. それでも解決しない場合はPMに連絡
```

### 6.4 ロールバック中にWebサーバーが起動しない

**症状**: `systemctl restart` 後にWebサーバーが起動しない

**原因**: 設定ファイルのエラー

**対処**:
```bash
# 1. 設定ファイルのチェック
sudo apache2ctl configtest    # Apache
sudo nginx -t                  # Nginx

# 2. エラーメッセージを確認して修正

# 3. 修正後に再起動
sudo systemctl restart apache2    # Apache
sudo systemctl restart nginx      # Nginx

# 4. ログ確認
sudo journalctl -u apache2 -n 50   # Apache
sudo journalctl -u nginx -n 50     # Nginx
```

### 6.5 データが消失している

**症状**: ロールバック後、一部のデータが存在しない

**原因**: バックアップ後に作成されたデータはロールバックで消失

**対処**:
```bash
# 1. 失敗バージョンのディレクトリを確認
ls -la /var/www/html/appsuite-itsm.failed_*/

# 2. localStorageのデータは失われる可能性がある
# （ブラウザローカルストレージのため）

# 3. ユーザーに以下を案内:
# - ブラウザのバックアップ機能を使用していた場合は復元可能
# - システム設定からバックアップファイルをインポート

# 4. 今後の対策:
# - 定期的なバックアップのエクスポートを推奨
# - クラウドストレージへのバックアップ保存
```

---

## 付録

### A. ロールバック実施記録シート

| 項目 | 内容 |
|------|------|
| 実施日時 | YYYY/MM/DD HH:MM - HH:MM |
| 実施者 | |
| 承認者 | |
| ロールバック理由 | |
| 使用したバックアップ | |
| 所要時間 | |
| 動作確認結果 | □ 正常 □ 異常 |
| 備考 | |

### B. 緊急連絡先

| 役割 | 氏名 | メール | 電話 |
|------|------|--------|------|
| PM | - | pm@example.com | 090-xxxx-xxxx |
| インフラ担当 | - | infra@example.com | 090-xxxx-xxxx |
| BE開発リード | - | be-lead@example.com | 090-xxxx-xxxx |

### C. 関連ドキュメント

- Phase5_リリース計画書.md
- デプロイ手順書.md
- 運用マニュアル(Operation-Manual).md

---

**文書履歴**

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0 | 2026-02-04 | 初版作成 | システム管理者 |
