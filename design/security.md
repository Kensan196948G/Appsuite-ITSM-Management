# セキュリティ設計書

## ドキュメント情報

| 項目 | 値 |
|------|-----|
| プロジェクト名 | AppSuite ITSM管理システム |
| バージョン | 1.0.0 |
| 作成日 | 2026-01-29 |
| 作成者 | Arch Reviewer Agent |
| ステータス | Draft |

## 1. セキュリティ概要

### 1.1 セキュリティ目標

| 目標 | 説明 | 対策 |
|------|------|------|
| 機密性 | 権限のないユーザーからのデータ保護 | 認証・認可 |
| 完全性 | データの不正変更防止 | 入力検証・監査ログ |
| 可用性 | 正当なユーザーへのサービス提供 | セッション管理 |
| 追跡可能性 | 操作履歴の記録・検証 | 監査ログ |

### 1.2 脅威モデル

```
┌─────────────────────────────────────────────────────────────┐
│                      脅威と対策マトリクス                     │
├───────────────────┬──────────────────┬─────────────────────┤
│ 脅威              │ 影響             │ 対策                 │
├───────────────────┼──────────────────┼─────────────────────┤
│ XSS攻撃           │ セッション窃取    │ 出力エスケープ        │
│ ブルートフォース   │ 不正アクセス      │ ロックアウト          │
│ セッションハイジャック│ なりすまし      │ タイムアウト          │
│ データ改ざん      │ データ破壊        │ 入力検証・ログ        │
│ 情報漏洩          │ プライバシー侵害  │ 権限管理              │
└───────────────────┴──────────────────┴─────────────────────┘
```

## 2. 認証・認可

### 2.1 認証フロー

```
┌─────────────────┐
│   ログイン画面   │
│  username/password│
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│ ロックアウト     │────▶│ エラー表示       │
│ チェック        │ YES  │ (残り待ち時間)   │
└────────┬────────┘     └─────────────────┘
         │ NO
         ▼
┌─────────────────┐     ┌─────────────────┐
│ ユーザー検索    │────▶│ エラー表示       │
│                 │ 不在 │ (認証失敗)       │
└────────┬────────┘     └─────────────────┘
         │ 存在
         ▼
┌─────────────────┐     ┌─────────────────┐
│ パスワード検証  │────▶│ 失敗カウント++   │
│ (SHA-256)       │ 不一致│ ロックアウト判定 │
└────────┬────────┘     └─────────────────┘
         │ 一致
         ▼
┌─────────────────┐
│ セッション作成  │
│ sessionStorage  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ ダッシュボード  │
└─────────────────┘
```

### 2.2 パスワードポリシー

| 項目 | 要件 | 実装 |
|------|------|------|
| 最小長 | 8文字以上 | PasswordValidator.check() |
| 大文字 | 1文字以上 | 正規表現チェック |
| 小文字 | 1文字以上 | 正規表現チェック |
| 数字 | 1文字以上 | 正規表現チェック |
| 特殊文字 | 推奨 | 正規表現チェック |
| ハッシュ | SHA-256 | crypto.subtle.digest() |

```javascript
// パスワード検証の実装
const PasswordValidator = {
    check(password) {
        const errors = [];
        if (password.length < 8) errors.push('8文字以上');
        if (!/[A-Z]/.test(password)) errors.push('大文字を含む');
        if (!/[a-z]/.test(password)) errors.push('小文字を含む');
        if (!/[0-9]/.test(password)) errors.push('数字を含む');
        return { valid: errors.length === 0, errors };
    }
};
```

### 2.3 ロックアウト機構

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| MAX_LOGIN_ATTEMPTS | 5 | 最大失敗回数 |
| LOCKOUT_DURATION | 15分 | ロック期間 |
| 解除方法 | 時間経過 | 自動解除 |

```javascript
// ロックアウトチェック
checkLockout(username) {
    const lockoutData = this.lockouts[username];
    if (!lockoutData) return false;

    const now = Date.now();
    if (now < lockoutData.until) {
        return true; // ロック中
    }

    delete this.lockouts[username];
    return false;
}
```

### 2.4 セッション管理

| 項目 | 値 | 説明 |
|------|-----|------|
| 保存先 | sessionStorage | ブラウザセッション限定 |
| タイムアウト | 30分 | 無操作時間 |
| 延長方法 | ユーザー操作 | クリック/キー入力で延長 |
| チェック間隔 | 1分 | 定期的に有効性確認 |

```javascript
// セッション構造
const session = {
    userId: 'U0001',
    username: '山田太郎',
    role: '管理者',
    loginTime: '2026-01-29T10:00:00Z',
    lastActivity: '2026-01-29T10:25:00Z',
    expiresAt: '2026-01-29T10:55:00Z'
};
```

## 3. 入力検証・XSS対策

### 3.1 XSS対策

| 対策 | 実装 | 適用箇所 |
|------|------|---------|
| 出力エスケープ | escapeHtml() | 全ての動的コンテンツ |
| HTMLエンコード | 特殊文字変換 | innerHTML挿入時 |
| URLエンコード | encodeURIComponent | URL生成時 |

```javascript
// XSSエスケープマッピング
const Security = {
    escapeHtml(str) {
        const escapeMap = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;',
            '/': '&#x2F;',
            '`': '&#x60;',
            '=': '&#x3D;'
        };
        return String(str).replace(/[&<>"'`=/]/g,
            char => escapeMap[char]);
    }
};
```

### 3.2 入力検証

| 検証項目 | メソッド | 説明 |
|---------|---------|------|
| 必須チェック | required() | 空でないこと |
| メール形式 | email() | 正規表現で検証 |
| 最小長 | minLength() | 最小文字数 |
| 最大長 | maxLength() | 最大文字数 |
| パターン | pattern() | 正規表現マッチ |

```javascript
const Validator = {
    required(value) {
        return value !== null && value !== undefined
            && String(value).trim().length > 0;
    },

    email(value) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(value);
    },

    minLength(value, min) {
        return String(value).length >= min;
    }
};
```

## 4. 監査ログ

### 4.1 ログ記録項目

| 項目 | 説明 | 例 |
|------|------|-----|
| timestamp | 操作日時 | 2026-01-29 10:30:15 |
| userId | 操作ユーザーID | U0001 |
| username | ユーザー名 | 山田太郎 |
| action | 操作種別 | create/update/delete/login |
| target | 操作対象 | ユーザー「鈴木花子」 |
| targetType | 対象タイプ | user/app/incident/change |
| detail | 詳細情報 | 新規ユーザー登録 |
| ipAddress | IPアドレス | 192.168.1.100 |

### 4.2 ログ記録対象

| アクション | 記録 | 詳細レベル |
|-----------|------|-----------|
| ログイン | ✅ | 成功/失敗 |
| ログアウト | ✅ | 通常/タイムアウト |
| ユーザー作成 | ✅ | 作成内容 |
| ユーザー更新 | ✅ | 変更内容 |
| ユーザー削除 | ✅ | 削除対象 |
| インシデント操作 | ✅ | 全CRUD |
| 変更要求操作 | ✅ | 全CRUD |
| 設定変更 | ✅ | 変更項目 |
| エクスポート | ✅ | 対象データ |

### 4.3 ログ保持ポリシー

| 項目 | 値 |
|------|-----|
| 最大保持件数 | 10,000件 |
| 保持期間 | 無制限（localStorage容量まで） |
| 超過時の処理 | 古いログから削除 |
| エクスポート形式 | CSV |

## 5. 権限管理

### 5.1 ロール定義

| ロール | 説明 | 割り当て |
|--------|------|---------|
| 管理者 | 全機能アクセス可能 | role: '管理者' |
| ユーザー | 制限付きアクセス | role: 'ユーザー' |

### 5.2 権限マトリクス

| 機能 | 管理者 | ユーザー |
|------|--------|---------|
| ダッシュボード閲覧 | ✅ | ✅ |
| ユーザー一覧表示 | ✅ | ✅ |
| ユーザー作成 | ✅ | ❌ |
| ユーザー編集 | ✅ | ❌ |
| ユーザー削除 | ✅ | ❌ |
| アプリ管理 | ✅ | ✅ (閲覧のみ) |
| インシデント作成 | ✅ | ✅ |
| インシデント編集 | ✅ | ✅ (自分のみ) |
| 変更要求作成 | ✅ | ✅ |
| 変更要求承認 | ✅ | ❌ |
| 監査ログ閲覧 | ✅ | ❌ |
| システム設定 | ✅ | ❌ |

### 5.3 権限チェック実装

```javascript
const AuthModule = {
    permissions: {
        'admin': ['管理者'],
        'user.create': ['管理者'],
        'user.delete': ['管理者'],
        'user.view': ['管理者', 'ユーザー'],
        'incident.create': ['管理者', 'ユーザー'],
        'settings.view': ['管理者'],
        // ...
    },

    hasPermission(permission) {
        const user = this.getCurrentUser();
        if (!user) return false;

        const allowedRoles = this.permissions[permission] || [];
        return allowedRoles.includes(user.role);
    }
};
```

## 6. データ保護

### 6.1 機密データの取り扱い

| データ | 保護方法 | 備考 |
|--------|---------|------|
| パスワード | SHA-256ハッシュ | 平文保存禁止 |
| APIキー | マスキング表示 | 入力時のみ表示 |
| セッション | sessionStorage | ブラウザ終了で消去 |
| ログイン試行 | メモリ保持 | リロードでリセット |

### 6.2 ストレージセキュリティ

| 項目 | リスク | 対策 |
|------|--------|------|
| localStorage | XSSで読み取り可能 | XSS対策の徹底 |
| sessionStorage | 同セッション内で共有 | タイムアウト実装 |
| Cookie | 未使用 | - |

## 7. セキュリティテスト

### 7.1 テスト項目

| カテゴリ | テスト内容 | 優先度 |
|---------|-----------|--------|
| 認証 | ログイン成功/失敗 | 高 |
| 認証 | ロックアウト動作 | 高 |
| 認証 | セッションタイムアウト | 高 |
| XSS | スクリプトインジェクション | 高 |
| XSS | イベントハンドラ注入 | 高 |
| 権限 | 管理者機能へのアクセス制限 | 高 |
| 権限 | ロール昇格防止 | 高 |
| 入力 | 不正入力の処理 | 中 |
| ログ | 監査ログ記録確認 | 中 |

### 7.2 テスト手順例

```
TC-SEC-001: XSS攻撃防御テスト
前提条件: ユーザー登録画面を表示
手順:
  1. ユーザー名に "<script>alert('XSS')</script>" を入力
  2. 登録ボタンをクリック
  3. ユーザー一覧を確認
期待結果:
  - スクリプトは実行されない
  - エスケープされた文字列として表示される
```

## 8. セキュリティ運用

### 8.1 日常チェックリスト

- [ ] 監査ログの確認（不審なアクセスがないか）
- [ ] ロックアウト発生状況の確認
- [ ] エラーログの確認

### 8.2 定期レビュー

| 項目 | 頻度 | 担当 |
|------|------|------|
| セキュリティログレビュー | 週次 | 管理者 |
| パスワードポリシー確認 | 月次 | 管理者 |
| 権限設定監査 | 四半期 | 管理者 |
| 脆弱性スキャン | 半年 | セキュリティチーム |

## 9. インシデント対応

### 9.1 対応フロー

```
セキュリティインシデント検知
         │
         ▼
┌─────────────────┐
│ 影響範囲の特定  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 一時的な遮断    │ ← 必要に応じて
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 証拠の保全      │ ← 監査ログ取得
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 原因の調査      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 対策の実施      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 報告・記録      │
└─────────────────┘
```

---

レビューステータス: **Draft - arch-reviewerによるレビュー待ち**
