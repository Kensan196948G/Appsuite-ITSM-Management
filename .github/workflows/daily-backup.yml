name: Daily Backup (AppSuite ITSM)

on:
  # æ¯Žæ—¥2:00 AMï¼ˆUTC 17:00 = JST 02:00ï¼‰
  schedule:
    - cron: '0 17 * * *'

  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:
    inputs:
      reason:
        description: 'Backup reason'
        required: false
        default: 'Manual backup'

permissions:
  contents: read

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # ========================================
      # Step 1: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # ========================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # Step 2: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ========================================
      # Step 3: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # ========================================
      - name: Install dependencies
        run: |
          npm ci || npm install
          npx playwright install chromium --with-deps

      # ========================================
      # Step 4: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
      # ========================================
      - name: Create backup directory
        run: mkdir -p backups

      # ========================================
      # Step 5: WebUIã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
      # ========================================
      - name: Start WebUI Server
        run: |
          cd WebUI-Production
          npx http-server . -p 8888 --silent &
          sleep 5
          echo "âœ… WebUI Server started on http://localhost:8888"

      # ========================================
      # Step 6: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
      # ========================================
      - name: Run Backup Script
        id: backup
        run: |
          node scripts/backup-automation.js
        env:
          BACKUP_DIR: ./backups
          WEBUI_URL: http://localhost:8888

      # ========================================
      # Step 7: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      # ========================================
      - name: Upload Backup Artifact
        uses: actions/upload-artifact@v4
        with:
          name: appsuite-backup-${{ github.run_id }}
          path: backups/*.json
          retention-days: 90  # 90æ—¥é–“ä¿æŒï¼ˆITSMç›£æŸ»å¯¾å¿œï¼‰

      # ========================================
      # Step 8: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼
      # ========================================
      - name: Verify Backup
        run: |
          echo "Verifying backup files..."
          for file in backups/*.json; do
            if [ -f "$file" ]; then
              SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)
              echo "âœ… $file: $((SIZE / 1024)) KB"

              # JSONå¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
              if ! jq empty "$file" 2>/dev/null; then
                echo "âŒ Invalid JSON: $file"
                exit 1
              fi
            fi
          done
          echo "âœ… All backup files verified successfully"

      # ========================================
      # Step 9: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µãƒžãƒªãƒ¼ç”Ÿæˆ
      # ========================================
      - name: Generate Backup Summary
        if: always()
        run: |
          echo "## ðŸ“¦ Daily Backup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backup Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|" >> $GITHUB_STEP_SUMMARY

          for file in backups/*.json; do
            if [ -f "$file" ]; then
              BASENAME=$(basename "$file")
              SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)
              echo "| $BASENAME | $((SIZE / 1024)) KB | âœ… |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Retention" >> $GITHUB_STEP_SUMMARY
          echo "Backup artifacts are retained for **90 days** (ITSM audit requirement)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "gh run download ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
